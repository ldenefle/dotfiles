#!/usr/bin/env bash

set -uo pipefail
SEEDBOX_DIR=/media/files
LOCAL_DIR=/media/backup/media/files
PLAYLISTS_DIR=~/Documents/Playlists
TARGET_DIR="${1}"

ROOT_ALL=${TARGET_DIR}/music
ROOT_MP3=${TARGET_DIR}/by-playlists

IP_ADDRESS="seedbox"

# Sync playlists
declare -a PLAYLISTS=(
    "ambient"
    "Afro Stiff"
    "Arabic Funk"
    "City Pop"
    "Dancehall"
    "Di N Bi"
    "Disco Party"
    "DJ Stuff"
    "Dubby Dub Dub"
    "French"
    "Good Stuff"
    "Grimey-Garagey"
    "HipHop Flava"
    "In da House"
    "Italo-balearico"
    "Jazz For Big Brainz"
    "Lating Stuff"
    "PC French Touch"
    "Rooftop Favs"
    "Soulful Stuff"
    "South Africa"
    "Techno Stuff"
    "Zouk"
)

dl() {
    PLAYLIST="${2}"
    TRACK="${1}"
    REMOTE_TRACK="${SEEDBOX_DIR}/${TRACK}"
    LOCAL_TRACK="${ROOT_ALL}${TRACK}"

    # Make the directory in the by-playlists dir
    mkdir -p "${PLAYLIST}"

    # Synchronize the file locally
    rsync -avP --mkpath seedbox:"${REMOTE_TRACK}" "${LOCAL_TRACK}"

    # Computing new name
    ARTIST=$(basename "$(dirname "${LOCAL_TRACK}")")
    # Extract the base name (filename.extension)
    base_name=$(basename "${LOCAL_TRACK}")
    # Extract the filename without the extension
    TRACKNAME="${base_name%.*}"
    # Combine them in the desired format
    FINAL_NAME="${TRACKNAME}_${ARTIST}.mp3"
    MP3_TRACK="${PLAYLIST}/${FINAL_NAME}"

    echo "Converting to ${LOCAL_TRACK} to ${MP3_TRACK}"

    if [ -e "${MP3_TRACK}" ]; then
        echo "Skipping ${MP3_TRACK}"
        return
    fi

    # Create the mp3 ordered by playlist
    case "${TRACK##*.}" in
        flac)
            echo "Converting to ${LOCAL_TRACK} to ${MP3_TRACK}"
            ffmpeg -i "${LOCAL_TRACK}" -ab 320k -map_metadata 0 -id3v2_version 3 "${MP3_TRACK}"
            ;;
        mp3)
            echo "MP3"
            cp "${LOCAL_TRACK}" "${MP3_TRACK}"
            ;;
        wav)
            echo "WAV"
            ;;
        *)
            echo "Unsupported"
            ;;
    esac
}

export -f dl

for i in "${PLAYLISTS[@]}"
do
    PLAYLIST="${PLAYLISTS_DIR}/${i}.m3u"
    echo "Syncing ${i} with ${PLAYLIST}"

    IFS=$'\n' read -a TRACKS -d '' < <( {
        ssh lucas@${IP_ADDRESS} '/opt/navidrome/navidrome --configfile /etc/navidrome/navidrome.toml pls -p "'${i}'"' 2>&1 |
            awk -v seed_dir=${SEEDBOX_DIR} '$0 ~ seed_dir { gsub(seed_dir, ""); print }'
    })

    for t in "${TRACKS[@]}"; do
        dl "${t}" "${ROOT_MP3}/${i#.m3u}"
    done
done
